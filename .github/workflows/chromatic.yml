name: 'Chromatic Deployment'

on:
   pull_request:
     branches:
       - develop

jobs:
   test:
     name: Storybook Chromatic Deployment
     runs-on: ubuntu-latest
     steps:
       - name: measure time
         run: 'echo "::set-output name=START_TIME::$(date +%s)"'

       - uses: actions/checkout@v1
       - name: Install pnpm
         uses: pnpm/action-setup@v4
         with:
           version: 9.1.3
       - name: Setup Node.js
         uses: actions/setup-node@v4
         with:
           node-version: 21
       - name: Install dependencies
         run: pnpm install --frozen-lockfile
       - name: Build tiki ui
         id: cache-tiki-ui
         uses: actions/cache@4
         with: 
          path: packages/ui/dist
          key: ${{runner.os}}-tiki-ui-${{hashFiles('packages/ui/package.json', 'packages/ui/src/**')}}
          restore-key: ${{runner.os}}-tiki-ui-
      
       - name: Build tiki icon
         id: cache-tiki-icon
         uses: action/cache@4
         with:
          path: packages/icon/dist
          key: ${{runner.os}}-tiki-icon-${{hashFiles('packages/icon/package.json', 'packages/icon/src/**')}}
          restore-key: ${{runner.os}}-tiki-icon

       - name: Check ui cache hit
         if: steps.cache-tiki-ui.outputs.cache-hit != 'true'
         run: pnpm --filter ui build

       - name: Check icon cache hit
         if: steps.cache-tiki-icon.outputs.cache-hit != 'true'
         run: pnpm --filter icon build

       - name: Run Chromatic
         id: chromatic
         uses: chromaui/action@v1
         with:
           projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
           token: ${{ secrets.GITHUB_TOKEN }}

       - name: measure time
         run: 'Total Build Time: $((END_TIME - $START_TIME)) seconds'

       - name: Comment PR
         uses: thollander/actions-comment-pull-request@v2
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
           message: |
              üöÄ Storybook ÌôïÏù∏ÌïòÍ∏∞ üöÄ
              - [Build](${{steps.chromatic.outputs.buildUrl}})
              - [Preview](${{steps.chromatic.outputs.storybookUrl}})